<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½åŠ©æ‰‹ - ç»ˆæç‰ˆ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        .main-container {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: 300px 1fr;
            overflow: hidden;
        }

        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            margin: 0 0 30px;
            font-size: 24px;
            font-weight: 600;
        }

        .menu-item {
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            background: #3498db;
        }

        .menu-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
        }

        .user-message {
            align-self: flex-end;
            background: #3498db;
            color: white;
            border-radius: 12px 12px 0 12px;
        }

        .bot-message {
            align-self: flex-start;
            background: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 0 12px 12px 12px;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 12px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-area input:focus {
            outline: none;
            border-color: #3498db;
        }

        .input-area button {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .input-area button:hover {
            background: #2980b9;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            margin-top: auto;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            margin: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.online {
            background: #2ecc71;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .suggestion-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-list div {
            padding: 8px;
            cursor: pointer;
        }

        .suggestion-list div:hover {
            background: #f0f0f0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-content h2 {
            margin-top: 0;
            font-size: 20px;
            color: #333;
        }

        .modal-content label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #555;
        }

        .modal-content select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .modal-content button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .modal-content button:hover {
            background-color: #0056b3;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
            .input-area {
                padding: 10px;
                flex-direction: column;
            }
            .input-area input {
                width: 100%;
                margin-bottom: 8px;
            }
            .input-area button {
                width: 100%;
            }
        }

        /* ç‚¹èµå’Œç‚¹è¸©æŒ‰é’®æ ·å¼ */
        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .feedback-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .feedback-buttons button.like {
            color: #2ecc71;
        }

        .feedback-buttons button.dislike {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h2>AI åŠ©æ‰‹</h2>
            <div class="menu-item active" onclick="showChat()">
                <span class="menu-icon">ğŸ’¬</span>
                èŠå¤©
            </div>
            <div class="menu-item" onclick="openSettings()">
                <span class="menu-icon">âš™ï¸</span>
                è®¾ç½®
            </div>
            <div class="menu-item" onclick="openKnowledge()">
                <span class="menu-icon">ğŸ“š</span>
                çŸ¥è¯†åº“
            </div>
            <div class="menu-item" onclick="openHistory()">
                <span class="menu-icon">ğŸ“Š</span>
                å†å²æŸ¥çœ‹
            </div>
            <div class="menu-item" onclick="openUserSettings()">
                <span class="menu-icon">ğŸ‘¤</span>
                ç”¨æˆ·è®¾ç½®
            </div>
            <div class="menu-item" onclick="openLanguageSettings()">
                <span class="menu-icon">ğŸŒ</span>
                è¯­è¨€è®¾ç½®
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- èŠå¤©çª—å£ -->
            <div class="chat-container" id="chatContainer">
                <div class="message bot-message">
                    <div class="message-content">æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ</div>
                    <div class="message-timestamp">12:00:00</div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <input type="text" id="userInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                <button onclick="sendMessage()">å‘é€</button>
                <button id="voiceInputButton" onclick="startVoiceInput()">ğŸ¤</button>
            </div>
            <div id="suggestionList" class="suggestion-list"></div>

            <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="status-indicator">
                <div class="status-dot online"></div>
                <span>ç³»ç»Ÿåœ¨çº¿</span>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>è®¾ç½®</h2>
            <label for="storageType">é€‰æ‹©å­˜å‚¨æ–¹å¼ï¼š</label>
            <select id="storageType">
                <option value="indexeddb">IndexedDB</option>
                <option value="localstorage">LocalStorage</option>
            </select>
            <button onclick="saveSettings()">ä¿å­˜</button>
        </div>
    </div>

    <!-- çŸ¥è¯†åº“å¼¹çª— -->
    <div class="modal" id="knowledgeModal">
        <div class="modal-content">
            <h2>çŸ¥è¯†åº“</h2>
            <ul id="knowledgeList"></ul>
        </div>
    </div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h2>å†å²è®°å½•</h2>
            <ul id="historyList"></ul>
        </div>
    </div>

    <!-- ç”¨æˆ·è®¾ç½®å¼¹çª— -->
    <div class="modal" id="userSettingsModal">
        <div class="modal-content">
            <h2>ç”¨æˆ·è®¾ç½®</h2>
            <label for="userName">ç”¨æˆ·åï¼š</label>
            <input type="text" id="userName" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            <label for="userTheme">ä¸»é¢˜ï¼š</label>
            <select id="userTheme">
                <option value="light">æµ…è‰²</option>
                <option value="dark">æ·±è‰²</option>
            </select>
            <button onclick="saveUserSettings()">ä¿å­˜</button>
        </div>
    </div>

    <!-- è¯­è¨€è®¾ç½®å¼¹çª— -->
    <div class="modal" id="languageModal">
        <div class="modal-content">
            <h2>è¯­è¨€è®¾ç½®</h2>
            <label for="languageSelect">é€‰æ‹©è¯­è¨€ï¼š</label>
            <select id="languageSelect">
                <option value="zh-CN">ä¸­æ–‡</option>
                <option value="en-US">English</option>
                <option value="ja-JP">æ—¥æœ¬èª</option>
            </select>
            <button onclick="saveLanguageSettings()">ä¿å­˜</button>
        </div>
    </div>

    <script>
        // å­˜å‚¨æ–¹å¼é…ç½®
        const STORAGE_TYPES = { INDEXEDDB: 'indexeddb', LOCALSTORAGE: 'localstorage' };
        let currentStorageType = localStorage.getItem('storageType') || STORAGE_TYPES.INDEXEDDB;

        // IndexedDB é…ç½®
        const DB_CONFIG = {
            name: 'AIChatDB',
            version: 2,
            stores: {
                knowledge: '++id, timestamp',
                conversations: '++id, sessionId, &timestamp'
            }
        };

        // æ•°æ®åº“å®ä¾‹
        let db = null;

        // åˆå§‹åŒ–æ•°æ®åº“
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('knowledge')) {
                        const store = db.createObjectStore('knowledge', {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        store.createIndex('by_key', 'key', { unique: true });
                    }

                    if (!db.objectStoreNames.contains('conversations')) {
                        const store = db.createObjectStore('conversations', {
                            keyPath: 'id'
                        });
                        store.createIndex('by_session', 'sessionId');
                        store.createIndex('by_timestamp', 'timestamp');
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // æ•°æ®åº“æ“ä½œç±»
        class DBApi {
            static async getKnowledge(key) {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('knowledge', 'readonly');
                    const store = tx.objectStore('knowledge');
                    const index = store.index('by_key');
                    const request = index.get(key);
                    
                    request.onsuccess = () => resolve(request.result?.value);
                    request.onerror = () => reject(request.error);
                });
            }

            static async saveKnowledge(key, value) {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('knowledge', 'readwrite');
                    const store = tx.objectStore('knowledge');
                    
                    // å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨
                    const index = store.index('by_key');
                    index.get(key).onsuccess = (e) => {
                        const data = e.target.result;
                        
                        if (data) {
                            data.value = value;
                            data.timestamp = Date.now();
                            store.put(data).onsuccess = () => resolve();
                            store.put(data).onerror = () => reject(tx.error);
                        } else {
                            store.add({ key, value, timestamp: Date.now() }).onsuccess = () => resolve();
                            store.add({ key, value, timestamp: Date.now() }).onerror = () => reject(tx.error);
                        }
                    };
                    
                    tx.onerror = () => reject(tx.error);
                });
            }

            static async saveConversation(sessionId, messages) {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('conversations', 'readwrite');
                    const store = tx.objectStore('conversations');
                    
                    store.add({
                        sessionId,
                        messages,
                        timestamp: Date.now()
                    }).onsuccess = () => resolve();
                    store.add({
                        sessionId,
                        messages,
                        timestamp: Date.now()
                    }).onerror = () => reject(tx.error);
                });
            }

            static async getAllConversations() {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('conversations', 'readonly');
                    const store = tx.objectStore('conversations');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // LocalStorage æ“ä½œç±»
        class LocalStorageApi {
            static async getKnowledge(key) {
                return JSON.parse(localStorage.getItem(key)) || {};
            }

            static async saveKnowledge(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            }

            static async saveConversation(sessionId, messages) {
                const conversations = JSON.parse(localStorage.getItem('conversations')) || [];
                conversations.push({ sessionId, messages, timestamp: Date.now() });
                localStorage.setItem('conversations', JSON.stringify(conversations));
            }

            static async getAllConversations() {
                return JSON.parse(localStorage.getItem('conversations')) || [];
            }
        }

        // ä¸Šä¸‹æ–‡ç®¡ç†å™¨
        class ContextManager {
            constructor() {
                this.context = [];
                this.maxContextLength = 5; // æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦
            }

            addContext(role, message) {
                this.context.push({ role, message });
                if (this.context.length > this.maxContextLength) {
                    this.context.shift(); // ç§»é™¤æœ€æ—©çš„ä¸Šä¸‹æ–‡
                }
            }

            getContext() {
                return this.context;
            }

            clearContext() {
                this.context = [];
            }
        }

        // å­¦ä¹ ç®¡ç†å™¨
        class LearningManager {
            constructor() {
                this.learnedData = {};
            }

            recordInteraction(userMessage, botResponse) {
                const key = userMessage.toLowerCase();
                if (!this.learnedData[key]) {
                    this.learnedData[key] = { count: 0, responses: [] };
                }
                this.learnedData[key].count++;
                this.learnedData[key].responses.push(botResponse);
            }

            getBestResponse(userMessage) {
                const key = userMessage.toLowerCase();
                if (this.learnedData[key]) {
                    const responses = this.learnedData[key].responses;
                    return responses[responses.length - 1]; // è¿”å›æœ€æ–°çš„å›åº”
                }
                return null;
            }
        }

        // å¢å¼ºåçš„è¯åº“ç±»
        class Vocabulary {
            constructor() {
                this.words = {
                    // åŸæœ‰è¯åº“
                    "é—®å€™": ["ä½ å¥½ï¼", "æ‚¨å¥½ï¼", "æ—©ä¸Šå¥½ï¼", "ä¸‹åˆå¥½ï¼", "æ™šä¸Šå¥½ï¼"],
                    "å‘Šåˆ«": ["å†è§ï¼", "æ‹œæ‹œï¼", "ä¸‹æ¬¡è§ï¼", "ç¥æ‚¨æœ‰ç¾å¥½çš„ä¸€å¤©ï¼"],
                    "æ„Ÿè°¢": ["ä¸å®¢æ°”ï¼", "å¾ˆé«˜å…´èƒ½å¸®åˆ°æ‚¨ï¼", "è¿™æ˜¯æˆ‘çš„è£å¹¸ï¼"],
                    "é“æ­‰": ["æ²¡å…³ç³»ï¼", "åˆ«æ‹…å¿ƒï¼", "å°äº‹ä¸€æ¡©ï¼"],
                    "è¯¢é—®": ["æˆ‘å¾ˆå¥½ï¼Œè°¢è°¢ï¼", "è¿˜ä¸é”™ï¼Œæ‚¨å‘¢ï¼Ÿ", "æŒºå¥½çš„ï¼Œæ‚¨æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ"],
                    "å»ºè®®": ["æ‚¨å¯ä»¥è¯•è¯•è¿™ä¸ªæ–¹æ³•ï¼", "æˆ‘å»ºè®®æ‚¨è¿™æ ·åšï¼", "ä¹Ÿè®¸æ‚¨å¯ä»¥è€ƒè™‘è¿™ä¸ªæ–¹æ¡ˆï¼"],
                    "å¤©æ°”": ["ä»Šå¤©å¤©æ°”ä¸é”™ï¼", "æœ€è¿‘å¤©æ°”å˜åŒ–å¤§ï¼Œè¯·æ³¨æ„ä¿æš–ï¼", "æ‚¨å¯ä»¥æŸ¥çœ‹å¤©æ°”é¢„æŠ¥è·å–è¯¦ç»†ä¿¡æ¯"],
                    "æ—¶é—´": ["ç°åœ¨æ˜¯åŒ—äº¬æ—¶é—´ï¼š", "å½“å‰æ—¶é—´æ˜¯ï¼š", new Date().toLocaleTimeString()],
                    "å¸®åŠ©": ["æˆ‘å¯ä»¥å¸®æ‚¨åšä»€ä¹ˆï¼Ÿ", "æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ", "è¯·å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚ï¼"],
                    "é»˜è®¤": ["æˆ‘ä¸å¤ªæ˜ç™½ï¼Œèƒ½å†è¯´è¯¦ç»†ç‚¹å—ï¼Ÿ", "è¿™ä¸ªæˆ‘éœ€è¦å†å­¦ä¹ ä¸€ä¸‹", "æ‚¨èƒ½æ¢ç§æ–¹å¼è¯´å—ï¼Ÿ"],
                    
                    // æ–°å¢è¯åº“
                    "ç¬‘è¯": ["ä¸ºä»€ä¹ˆç¨‹åºå‘˜æ€»åˆ†ä¸æ¸…ä¸‡åœ£èŠ‚å’Œåœ£è¯èŠ‚ï¼Ÿå› ä¸º Oct 31 == Dec 25ï¼", 
                           "ä»€ä¹ˆæ¤…å­æœ€ä¸å–œæ¬¢åäººï¼Ÿç”µæ¤…ï¼",
                           "ä¸ºä»€ä¹ˆæ•°å­¦ä¹¦æ€»æ˜¯å¾ˆæ‚²ä¼¤ï¼Ÿå› ä¸ºå®ƒæœ‰å¤ªå¤šçš„é—®é¢˜ï¼"],
                    "æ–°é—»": ["ä»Šæ—¥å¤´æ¡ï¼šäººå·¥æ™ºèƒ½åŠ©åŠ›åŒ»ç–—é¢†åŸŸçªç ´", 
                          "ç§‘æŠ€å¿«è®¯ï¼šé‡å­è®¡ç®—æœºç ”å‘å–å¾—æ–°è¿›å±•",
                          "è´¢ç»æ–°é—»ï¼šå…¨çƒæ•°å­—è´§å¸å¸‚å€¼åˆ›æ–°é«˜"],
                    "é¥®é£Ÿ": ["å¥åº·å°è´´å£«ï¼šæ¯å¤©å»ºè®®å–8æ¯æ°´", 
                          "çƒ¹é¥ªæŠ€å·§ï¼šç‚’èœæ—¶é€‚é‡åŠ é†‹å¯ä»¥ä¿ç•™ç»´ç”Ÿç´ ",
                          "è¥å…»å»ºè®®ï¼šå¤šåƒæ·±è‰²è”¬èœæœ‰ç›Šå¥åº·"]
                };
                
                this.patterns = {
                    // åŸæœ‰æ¨¡å¼
                    "ä½ ä¼šå¼€(.*)å—ï¼Ÿ": "æˆ‘æ˜¯AIï¼Œä¸ä¼šå¼€$1ï¼Œä½†å¯ä»¥å¸®æ‚¨æ‰¾åˆ°æœ€å¥½çš„$1æ•™ç¨‹ï¼",
                    "æ€ä¹ˆ(.*)": "å…³äº$1ï¼Œå»ºè®®æ‚¨å¯ä»¥ï¼š1.æŸ¥é˜…ç›¸å…³èµ„æ–™ 2.è§‚çœ‹æ•™å­¦è§†é¢‘ 3.å’¨è¯¢ä¸“ä¸šäººå£«",
                    "ä¸ºä»€ä¹ˆ(.*)": "$1çš„åŸå› å¯èƒ½åŒ…æ‹¬ï¼š1.ç³»ç»Ÿè®¾ç½® 2.ç¯å¢ƒå› ç´  3.æ“ä½œæ–¹å¼ï¼Œéœ€è¦å…·ä½“åˆ†æ",
                    
                    // æ–°å¢æ¨¡å¼
                    "å“ªé‡Œå¯ä»¥(.*)": "å…³äº$1çš„ä½ç½®ä¿¡æ¯ï¼Œæ¨èä½¿ç”¨åœ°å›¾åº”ç”¨æœç´¢ï¼š<a href='https://maps.example.com?q=$1' target='_blank'>ç«‹å³æŸ¥è¯¢</a>",
                    "æœ€æ–°(.*)æ¶ˆæ¯": "æ­£åœ¨ä¸ºæ‚¨è·å–æœ€æ–°çš„$1èµ„è®¯... <button onclick='fetchNews(\"$1\")'>ç‚¹å‡»åŠ è½½</button>",
                    "(.*)å¤šå°‘é’±": "ä¸ºæ‚¨æ‰¾åˆ°$1çš„ä»·æ ¼å‚è€ƒï¼š<div class='price-checker' data-item='$1'></div>"
                };

                // ç¼“å­˜ä¼˜åŒ–
                this.cachedKeys = Object.keys(this.words).map(k => k.toLowerCase());
                this.synonyms = {
                    "é—®å€™": ["ä½ å¥½", "hi", "hello"],
                    "æ—¶é—´": ["å‡ ç‚¹", "é’Ÿç‚¹", "æ—¶è¾°"]
                };
            }

            // ä¼˜åŒ–åçš„æ¨¡ç³ŠåŒ¹é…ç®—æ³•
            findClosestKey(input) {
                const cleanInput = input.toLowerCase().replace(/[^\w\u4e00-\u9fa5]/g, '');
                let minDistance = Infinity;
                let closestKey = null;

                // ä¼˜å…ˆæ£€æŸ¥å®Œå…¨åŒ¹é…
                if (this.words[cleanInput]) return cleanInput;

                // ä½¿ç”¨ç¼“å­˜çš„å…³é”®è¯åˆ—è¡¨
                for (const key of this.cachedKeys) {
                    // è®¡ç®—ç›¸ä¼¼åº¦çš„ä¼˜åŒ–æ–¹æ³•
                    const distance = this.optimizedDistance(cleanInput, key);
                    if (distance < minDistance && distance <= 2) {
                        minDistance = distance;
                        closestKey = key;
                    }
                }
                return closestKey;
            }

            // ä¼˜åŒ–åçš„ç¼–è¾‘è·ç¦»è®¡ç®—ï¼ˆä½¿ç”¨æ»šåŠ¨æ•°ç»„ï¼‰
            optimizedDistance(a, b) {
                if (a.length === 0) return b.length;
                if (b.length === 0) return a.length;

                let prevRow = Array.from({length: b.length + 1}, (_, i) => i);
                let currRow = new Array(b.length + 1);

                for (let i = 1; i <= a.length; i++) {
                    currRow[0] = i;
                    for (let j = 1; j <= b.length; j++) {
                        const cost = a[i-1] === b[j-1] ? 0 : 1;
                        currRow[j] = Math.min(
                            prevRow[j] + 1,    // åˆ é™¤
                            currRow[j-1] + 1,  // æ’å…¥
                            prevRow[j-1] + cost // æ›¿æ¢
                        );
                    }
                    [prevRow, currRow] = [currRow, new Array(b.length + 1)];
                }
                return prevRow[b.length];
            }

            // å¢å¼ºçš„å“åº”è·å–
            getResponse(input) {
                // ä¼˜å…ˆåŒ¹é…æ¨¡å¼
                for (const [pattern, response] of Object.entries(this.patterns)) {
                    const regex = new RegExp(pattern);
                    const match = input.match(regex);
                    if (match) {
                        return response.replace(/\$1/g, match[1] || "");
                    }
                }

                // æ¨¡ç³ŠåŒ¹é…å…³é”®è¯
                const closestKey = this.findClosestKey(input);
                if (closestKey) {
                    const responses = this.words[closestKey];
                    return responses[Math.floor(Math.random() * responses.length)];
                }

                // åŒä¹‰è¯å¤„ç†
                for (const [key, synonyms] of Object.entries(this.synonyms)) {
                    if (synonyms.includes(input.toLowerCase())) {
                        return this.words[key][Math.floor(Math.random() * this.words[key].length)];
                    }
                }

                return this.words["é»˜è®¤"][0];
            }
        }

        // èŠå¤©ç³»ç»Ÿæ ¸å¿ƒ
        class ChatSystem {
            constructor() {
                this.sessionId = Date.now().toString(36);
                this.knowledge = {};
                this.contextManager = new ContextManager();
                this.learningManager = new LearningManager();
                this.vocabulary = new Vocabulary();
            }

            async initialize() {
                try {
                    if (currentStorageType === STORAGE_TYPES.INDEXEDDB) {
                        await initDB();
                    }
                    await this.loadKnowledge();
                    this.enableUI();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    await this.fallbackToLocalStorage();
                }
            }

            async loadKnowledge() {
                const keys = ['responses', 'learnedData', 'contextConfig'];
                
                for (const key of keys) {
                    if (currentStorageType === STORAGE_TYPES.INDEXEDDB) {
                        this.knowledge[key] = await DBApi.getKnowledge(key) || {};
                    } else {
                        this.knowledge[key] = await LocalStorageApi.getKnowledge(key) || {};
                    }
                }
            }

            async saveKnowledge(key) {
                if (currentStorageType === STORAGE_TYPES.INDEXEDDB) {
                    await DBApi.saveKnowledge(key, this.knowledge[key]);
                } else {
                    await LocalStorageApi.saveKnowledge(key, this.knowledge[key]);
                }
            }

            async saveConversation(sessionId, messages) {
                if (currentStorageType === STORAGE_TYPES.INDEXEDDB) {
                    await DBApi.saveConversation(sessionId, messages);
                } else {
                    await LocalStorageApi.saveConversation(sessionId, messages);
                }
            }

            async getAllConversations() {
                if (currentStorageType === STORAGE_TYPES.INDEXEDDB) {
                    return await DBApi.getAllConversations();
                } else {
                    return await LocalStorageApi.getAllConversations();
                }
            }

            async fallbackToLocalStorage() {
                console.warn('ä½¿ç”¨ LocalStorage ä½œä¸ºå¤‡ç”¨å­˜å‚¨');
                currentStorageType = STORAGE_TYPES.LOCALSTORAGE;
                await this.loadKnowledge();
            }

            enableUI() {
                document.getElementById('userInput').disabled = false;
                document.querySelector('.input-container button').disabled = false;
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.lastElementChild.textContent = 'ç³»ç»Ÿå°±ç»ªï¼Œå¯ä»¥å¼€å§‹å¯¹è¯';
            }

            async processMessage(message) {
                // è®°å½•ç”¨æˆ·æ¶ˆæ¯åˆ°ä¸Šä¸‹æ–‡
                this.contextManager.addContext('user', message);

                // æ£€æŸ¥è¯åº“
                const vocabResponse = this.vocabulary.getResponse(message);
                if (vocabResponse) {
                    return vocabResponse;
                }

                // æ£€æŸ¥å­¦ä¹ æ•°æ®
                const learnedResponse = this.learningManager.getBestResponse(message);
                if (learnedResponse) {
                    return learnedResponse;
                }

                // è·å–å¤–éƒ¨çŸ¥è¯†
                const externalKnowledge = await fetchExternalKnowledge(message);

                // ç”Ÿæˆå›åº”
                const response = `å›åº”: ${message}ã€‚${externalKnowledge}`;

                // è®°å½•AIå›åº”åˆ°ä¸Šä¸‹æ–‡
                this.contextManager.addContext('bot', response);

                // è®°å½•äº¤äº’
                this.learningManager.recordInteraction(message, response);

                await this.saveRelevantData();
                return response;
            }

            async saveRelevantData() {
                await Promise.all([
                    this.saveKnowledge('responses'),
                    this.saveKnowledge('learnedData'),
                    this.saveConversation(this.sessionId, this.getConversationHistory())
                ]);
            }

            getConversationHistory() {
                const chatContainer = document.getElementById('chatContainer');
                return Array.from(chatContainer.children)
                    .filter(msg => msg.classList.contains('message'))
                    .map(msg => ({
                        role: msg.classList.contains('user-message') ? 'user' : 'bot',
                        content: msg.querySelector('.message-content').textContent,
                        timestamp: msg.querySelector('.message-timestamp').textContent
                    }));
            }
        }

        // æ¨¡æ‹Ÿå¤–éƒ¨çŸ¥è¯†è·å–
        async function fetchExternalKnowledge(query) {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(`å¤–éƒ¨çŸ¥è¯†: ${query}`);
                }, 1000);
            });
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        const chatSystem = new ChatSystem();
        chatSystem.initialize();

        // UIäº¤äº’å‡½æ•°
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            const chatContainer = document.getElementById('chatContainer');
            
            // ç”¨æˆ·æ¶ˆæ¯
            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
                <div class="message-status">å·²å‘é€ <span class="icon">âœ”ï¸</span></div>
            `;
            chatContainer.appendChild(userMsg);

            input.value = '';
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // æ˜¾ç¤ºâ€œæ­£åœ¨æ€è€ƒâ€åŠ¨ç”»
            const thinkingIndicator = document.createElement('div');
            thinkingIndicator.className = 'thinking-indicator';
            thinkingIndicator.innerHTML = `
                <span></span>
                <span></span>
                <span></span>
            `;
            chatContainer.appendChild(thinkingIndicator);
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // å¤„ç†æ¶ˆæ¯å¹¶è·å–å›åº”
                const response = await chatSystem.processMessage(message);

                // ç§»é™¤â€œæ­£åœ¨æ€è€ƒâ€åŠ¨ç”»
                chatContainer.removeChild(thinkingIndicator);

                // æœºå™¨äººæ¶ˆæ¯
                const botMsg = document.createElement('div');
                botMsg.className = 'message bot-message';
                botMsg.innerHTML = `
                    <div class="message-content typing-animation">${response}</div>
                    <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
                    <div class="feedback-buttons">
                        <button class="like" onclick="handleFeedback('like', '${response}')">ğŸ‘</button>
                        <button class="dislike" onclick="handleFeedback('dislike', '${response}')">ğŸ‘</button>
                    </div>
                `;
                chatContainer.appendChild(botMsg);

                // é€è¡Œè¾“å…¥åŠ¨ç”»
                const contentElement = botMsg.querySelector('.message-content');
                const fullText = contentElement.textContent;
                contentElement.textContent = '';
                let index = 0;

                const typingInterval = setInterval(() => {
                    if (index < fullText.length) {
                        contentElement.textContent += fullText[index];
                        index++;
                    } else {
                        clearInterval(typingInterval);
                        contentElement.classList.remove('typing-animation');
                    }
                }, 50); // æ¯50msæ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } catch (error) {
                // ç§»é™¤â€œæ­£åœ¨æ€è€ƒâ€åŠ¨ç”»
                chatContainer.removeChild(thinkingIndicator);

                const errorMsg = document.createElement('div');
                errorMsg.className = 'message bot-message';
                errorMsg.innerHTML = `
                    <div class="message-content">ç³»ç»Ÿé”™è¯¯ï¼š${error.message}</div>
                    <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
                `;
                chatContainer.appendChild(errorMsg);

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // å¤„ç†ç”¨æˆ·åé¦ˆ
        function handleFeedback(type, response) {
            const key = response.toLowerCase();
            if (type === 'like') {
                chatSystem.learningManager.recordInteraction(key, response);
                alert('æ„Ÿè°¢æ‚¨çš„ç‚¹èµï¼');
            } else if (type === 'dislike') {
                chatSystem.learningManager.recordInteraction(key, response);
                alert('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šæ”¹è¿›ï¼');
            }
        }

        // ç›‘å¬å›è½¦é”®
        document.getElementById('userInput').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æ¢è¡Œï¼‰
                sendMessage(); // å‘é€æ¶ˆæ¯
            }
        });

        // è‡ªåŠ¨ä¿å­˜æœºåˆ¶
        setInterval(async () => {
            await chatSystem.saveKnowledge('responses');
            await chatSystem.saveKnowledge('learnedData');
        }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜

        window.addEventListener('beforeunload', async () => {
            await chatSystem.saveRelevantData();
        });

        // è®¾ç½®å¼¹çª—åŠŸèƒ½
        function openSettings() {
            const settingsModal = document.getElementById('settingsModal');
            const storageTypeSelect = document.getElementById('storageType');
            storageTypeSelect.value = currentStorageType;
            settingsModal.classList.add('open');
        }

        function saveSettings() {
            const storageTypeSelect = document.getElementById('storageType');
            const newStorageType = storageTypeSelect.value;

            if (newStorageType !== currentStorageType) {
                currentStorageType = newStorageType;
                localStorage.setItem('storageType', currentStorageType);

                // é‡æ–°åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ
                chatSystem = new ChatSystem();
                chatSystem.initialize();

                alert('è®¾ç½®å·²ä¿å­˜ï¼Œç³»ç»Ÿå·²é‡æ–°åˆå§‹åŒ–ã€‚');
            } else {
                alert('è®¾ç½®å·²ä¿å­˜ã€‚');
            }

            closeSettings();
        }

        function closeSettings() {
            const settingsModal = document.getElementById('settingsModal');
            settingsModal.classList.remove('open');
        }

        // çŸ¥è¯†åº“å¼¹çª—åŠŸèƒ½
        function openKnowledge() {
            const knowledgeModal = document.getElementById('knowledgeModal');
            const knowledgeList = document.getElementById('knowledgeList');
            knowledgeList.innerHTML = '';

            // åŠ è½½çŸ¥è¯†åº“æ•°æ®
            const vocabulary = chatSystem.vocabulary;
            for (const [key, responses] of Object.entries(vocabulary.words)) {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${key}</strong>: ${responses.join(', ')}`;
                knowledgeList.appendChild(li);
            }

            knowledgeModal.classList.add('open');
        }

        function closeKnowledge() {
            const knowledgeModal = document.getElementById('knowledgeModal');
            knowledgeModal.classList.remove('open');
        }

        // å†å²è®°å½•å¼¹çª—åŠŸèƒ½
        async function openHistory() {
            const historyModal = document.getElementById('historyModal');
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            // åŠ è½½å†å²è®°å½•
            const conversations = await chatSystem.getAllConversations();
            conversations.forEach(conversation => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${new Date(conversation.timestamp).toLocaleString()}</strong>: ${conversation.messages.map(msg => `${msg.role}: ${msg.content}`).join('<br>')}`;
                historyList.appendChild(li);
            });

            historyModal.classList.add('open');
        }

        function closeHistory() {
            const historyModal = document.getElementById('historyModal');
            historyModal.classList.remove('open');
        }

        // æ˜¾ç¤ºèŠå¤©çª—å£
        function showChat() {
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('input-area').style.display = 'flex';
        }

        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        function startVoiceInput() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
            };

            recognition.onerror = (event) => {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
            };
        }

        // è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½
        const autoCompleteData = ['ä½ å¥½', 'å¤©æ°”', 'æ—¶é—´', 'ç¬‘è¯', 'æ–°é—»', 'å¸®åŠ©'];

        document.getElementById('userInput').addEventListener('input', (event) => {
            const input = event.target.value;
            const suggestions = autoCompleteData.filter(item => item.startsWith(input));
            const suggestionList = document.getElementById('suggestionList');

            if (suggestions.length > 0) {
                suggestionList.innerHTML = suggestions.map(item => `<div onclick="selectSuggestion('${item}')">${item}</div>`).join('');
                suggestionList.style.display = 'block';
            } else {
                suggestionList.style.display = 'none';
            }
        });

        function selectSuggestion(suggestion) {
            document.getElementById('userInput').value = suggestion;
            document.getElementById('suggestionList').style.display = 'none';
        }

        // ç”¨æˆ·è®¾ç½®åŠŸèƒ½
        function openUserSettings() {
            const userSettingsModal = document.getElementById('userSettingsModal');
            userSettingsModal.classList.add('open');
        }

        function saveUserSettings() {
            const userName = document.getElementById('userName').value;
            const userTheme = document.getElementById('userTheme').value;

            localStorage.setItem('userName', userName);
            localStorage.setItem('userTheme', userTheme);

            applyUserSettings();
            closeUserSettings();
        }

        function applyUserSettings() {
            const userName = localStorage.getItem('userName') || 'ç”¨æˆ·';
            const userTheme = localStorage.getItem('userTheme') || 'light';

            document.body.classList.toggle('dark-theme', userTheme === 'dark');
            document.getElementById('userName').value = userName;
            document.getElementById('userTheme').value = userTheme;
        }

        function closeUserSettings() {
            const userSettingsModal = document.getElementById('userSettingsModal');
            userSettingsModal.classList.remove('open');
        }

        // åˆå§‹åŒ–ç”¨æˆ·è®¾ç½®
        applyUserSettings();

        // è¯­è¨€è®¾ç½®åŠŸèƒ½
        function openLanguageSettings() {
            const languageModal = document.getElementById('languageModal');
            languageModal.classList.add('open');
        }

        function saveLanguageSettings() {
            const languageSelect = document.getElementById('languageSelect');
            const selectedLanguage = languageSelect.value;
            localStorage.setItem('language', selectedLanguage);
            alert('è¯­è¨€è®¾ç½®å·²ä¿å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ›´æ”¹ã€‚');
            closeLanguageSettings();
        }

        function closeLanguageSettings() {
            const languageModal = document.getElementById('languageModal');
            languageModal.classList.remove('open');
        }

        // åˆå§‹åŒ–è¯­è¨€è®¾ç½®
        const currentLanguage = localStorage.getItem('language') || 'zh-CN';
        document.getElementById('languageSelect').value = currentLanguage;
    </script>
</body>
</html>
